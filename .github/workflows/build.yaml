name: Build and Push Analytics Service
"on":
    push:
        branches:
            - main
    release:
        types:
            - published
    workflow_dispatch: null
env:
    TARGET_PLATFORMS: linux/arm64
    DOCKER_API_VERSION: 1.43
jobs:
    build:
        runs-on: ubuntu-24.04-arm
        name: Build and Push Docker image
        if: >-
            github.event_name == 'push' || github.event_name == 'workflow_dispatch' ||
            startsWith(github.event.release.tag_name, 'analytics-v')
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Extract version from release
              id: version
              run: >
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{
                  github.event_name }}" == "push" ]; then
                    VERSION=$(grep '^version' pyproject.toml | sed 's/.*"\(.*\)"/\1/')
                  else
                    # Extract version from release tag (e.g., analytics-v1.0.0 -> 1.0.0)
                    TAG_NAME="${{ github.event.release.tag_name }}"
                    if [[ "$TAG_NAME" =~ analytics-v(.*) ]]; then
                      VERSION="${BASH_REMATCH[1]}"
                    else
                      echo "Error: Tag name doesn't match expected pattern"
                      exit 1
                    fi
                  fi

                  echo "version=$VERSION" >> $GITHUB_OUTPUT

                  echo "Version: $VERSION"
            - name: Login to DockerHub
              uses: docker/login-action@v3
              with:
                  username: "${{ secrets.DOCKERHUB_USERNAME }}"
                  password: "${{ secrets.DOCKERHUB_TOKEN }}"
            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3
            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v3
            - name: Docker meta
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: petretiandrea/beaesthetic-analytics
                  tags: >
                      type=semver,pattern={{version}},value=${{
                      steps.version.outputs.version }}

                      type=semver,pattern={{major}}.{{minor}},value=${{
                      steps.version.outputs.version }}

                      type=semver,pattern={{major}},value=${{
                      steps.version.outputs.version }}

                      type=raw,value=latest,enable=${{ github.event_name == 'push' ||
                      github.event_name == 'workflow_dispatch' }}
            - name: Build and push
              uses: docker/build-push-action@v5
              with:
                  file: ./Dockerfile
                  context: .
                  push: true
                  tags: "${{ steps.meta.outputs.tags }}"
                  labels: "${{ steps.meta.outputs.labels }}"
                  platforms: "${{ env.TARGET_PLATFORMS }}"
